{% extends "base.html" %}

{% block title %}Community Forum - IntelliLearn{% endblock %}

{% block page_title %}Community Forum{% endblock %}

{% block content %}
<div class="forum-container">
    <div class="forum-header">
        <div class="header-info">
            <p>Connect with other learners, share resources, ask questions, and help each other succeed.</p>
        </div>
        
        {% if 'username' in session %}
        <button class="btn btn-primary" id="new-post-btn">
            <i class="fas fa-plus"></i> New Post
        </button>
        {% else %}
        <a href="{{ url_for('login') }}" class="btn btn-primary">
            <i class="fas fa-sign-in-alt"></i> Login to Post
        </a>
        {% endif %}
    </div>
    
    <!-- Search and Filter Bar -->
    <div class="forum-search-filter">
        <form class="search-form" method="GET" action="{{ url_for('forum') }}">
            <div class="search-container">
                <input type="text" name="search" placeholder="Search posts..." value="{{ current_search }}">
                <button type="submit" class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <div class="filters-container">
                <div class="filter-group">
                    <label for="filter-topic">Topic:</label>
                    <select id="filter-topic" name="topic" class="filter-select">
                        <option value="">All Topics</option>
                        {% for topic in topics %}
                        <option value="{{ topic }}" {% if current_topic == topic %}selected{% endif %}>{{ topic }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-sort">Sort by:</label>
                    <select id="filter-sort" name="sort" class="filter-select">
                        <option value="recent" {% if current_sort == 'recent' %}selected{% endif %}>Most Recent</option>
                        <option value="popular" {% if current_sort == 'popular' %}selected{% endif %}>Most Popular</option>
                        <option value="likes" {% if current_sort == 'likes' %}selected{% endif %}>Most Liked</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-secondary btn-sm">
                    <i class="fas fa-filter"></i> Apply
                </button>
                
                {% if current_search or current_topic or current_sort != 'recent' %}
                <a href="{{ url_for('forum') }}" class="btn btn-outline btn-sm">
                    <i class="fas fa-times"></i> Clear
                </a>
                {% endif %}
            </div>
        </form>
    </div>
    
    <!-- Active filters display -->
    {% if current_search or current_topic %}
    <div class="active-filters">
        <span class="filters-label">Active filters:</span>
        
        {% if current_search %}
        <span class="filter-badge">
            Search: "{{ current_search }}"
            <a href="{{ url_for('forum', topic=current_topic, sort=current_sort) }}" class="remove-filter">×</a>
        </span>
        {% endif %}
        
        {% if current_topic %}
        <span class="filter-badge">
            Topic: {{ current_topic }}
            <a href="{{ url_for('forum', search=current_search, sort=current_sort) }}" class="remove-filter">×</a>
        </span>
        {% endif %}
    </div>
    {% endif %}
    
    <div id="forum-posts" class="posts-container">
        {% if posts %}
            {% for post in posts %}
            <div class="forum-post">
                <div class="post-header">
                    <div class="post-author">
                        <div class="author-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="author-info">
                            <div class="author-name">{{ post.author }}</div>
                            <div class="post-time" data-timestamp="{{ post.timestamp }}">{{ post.timestamp|timestamp_format }}</div>
                        </div>
                    </div>
                    
                    {% if post.topic %}
                    <div class="post-topic">
                        <a href="{{ url_for('forum', topic=post.topic) }}" class="topic-badge">
                            {{ post.topic }}
                        </a>
                    </div>
                    {% endif %}
                    
                    {% if session.username and post.author == session.username %}
                    <div class="post-options">
                        <button class="btn-delete-post" data-post-id="{{ post.id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
                
                <h3 class="post-title">{{ post.title }}</h3>
                <div class="post-content">{{ post.content }}</div>
                
                {% if post.has_image %}
                <div class="post-image">
                    <img src="{{ url_for('static', filename='uploads/' + post.image_path) }}" alt="Post image">
                </div>
                {% endif %}
                
                <div class="post-actions">
                    <div class="reaction-buttons">
                        <button class="btn-action btn-like {% if post.user_reaction == 'like' %}active{% endif %}" data-post-id="{{ post.id }}">
                            <i class="fas fa-thumbs-up"></i> <span class="like-count">{{ post.likes }}</span>
                        </button>
                        <button class="btn-action btn-dislike {% if post.user_reaction == 'dislike' %}active{% endif %}" data-post-id="{{ post.id }}">
                            <i class="fas fa-thumbs-down"></i> <span class="dislike-count">{{ post.dislikes }}</span>
                        </button>
                    </div>
                    <button class="btn-action btn-comments">
                        <i class="far fa-comment"></i> <span class="comment-count">{{ post.comments|length }}</span> Comments
                    </button>
                </div>
                
                <div class="comments-container">
                    {% if post.comments %}
                        {% for comment in post.comments %}
                        <div class="comment">
                            <div class="comment-header">
                                <div class="comment-author">{{ comment.author }}</div>
                                <div class="comment-time">{{ comment.timestamp|timestamp_format }}</div>
                                {% if session.username and comment.author == session.username %}
                                <div class="comment-options">
                                    <button class="btn-delete-comment" data-comment-id="{{ comment.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            <div class="comment-content">{{ comment.content }}</div>
                            
                            {% if comment.has_image %}
                            <div class="comment-image">
                                <img src="{{ url_for('static', filename='uploads/' + comment.image_path) }}" alt="Comment image">
                            </div>
                            {% endif %}
                            
                            <div class="comment-actions">
                                <button class="btn-action btn-like-comment {% if comment.user_reaction == 'like' %}active{% endif %}" data-comment-id="{{ comment.id }}">
                                    <i class="fas fa-thumbs-up"></i> <span class="like-count">{{ comment.likes }}</span>
                                </button>
                                <button class="btn-action btn-dislike-comment {% if comment.user_reaction == 'dislike' %}active{% endif %}" data-comment-id="{{ comment.id }}">
                                    <i class="fas fa-thumbs-down"></i> <span class="dislike-count">{{ comment.dislikes }}</span>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                    
                    {% if 'username' in session %}
                    <form class="comment-form" data-post-id="{{ post.id }}" enctype="multipart/form-data">
                        <div class="comment-input-container">
                            <input type="text" class="comment-input" placeholder="Write a comment..." name="content" required>
                            <div class="comment-image-upload">
                                <input type="file" id="comment-image-{{ post.id }}" name="image" accept="image/*" class="file-input">
                                <label for="comment-image-{{ post.id }}" class="file-input-icon">
                                    <i class="fas fa-image"></i>
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div id="comment-image-preview-{{ post.id }}" class="image-preview"></div>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                {% if current_search or current_topic %}
                <i class="fas fa-search empty-icon"></i>
                <h3>No matching posts found</h3>
                <p>Try changing your search criteria or remove some filters</p>
                <a href="{{ url_for('forum') }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Clear All Filters
                </a>
                {% else %}
                <i class="fas fa-comments empty-icon"></i>
                <h3>No posts yet</h3>
                <p>Be the first to start a discussion!</p>
                {% if 'username' in session %}
                <button class="btn btn-primary" id="empty-new-post-btn">
                    <i class="fas fa-plus"></i> Create Post
                </button>
                {% else %}
                <a href="{{ url_for('login') }}" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Login to Post
                </a>
                {% endif %}
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- New Post Modal -->
<div id="new-post-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New Post</h2>
            <span class="modal-close">&times;</span>
        </div>
        <div class="modal-body">
            <form id="forum-post-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="post-title" class="form-label">Title</label>
                    <input type="text" id="post-title" name="title" required placeholder="What's your topic about?">
                </div>
                
                <div class="form-group">
                    <label for="post-topic" class="form-label">Topic</label>
                    <select id="post-topic" name="topic" class="form-control">
                        <option value="">Select a Topic (Optional)</option>
                        <option value="Question">Question</option>
                        <option value="Discussion">Discussion</option>
                        <option value="Resource">Resource</option>
                        <option value="Study Group">Study Group</option>
                        <option value="Project">Project</option>
                        <option value="Career">Career</option>
                        <option value="Help Needed">Help Needed</option>
                        <option value="Success Story">Success Story</option>
                        <option value="News">News</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="post-content" class="form-label">Content</label>
                    <textarea id="post-content" name="content" rows="6" required placeholder="Share your thoughts, questions, or resources..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="post-image" class="form-label">Add Image (optional)</label>
                    <div class="file-input-container">
                        <input type="file" id="post-image" name="image" accept="image/*" class="file-input">
                        <label for="post-image" class="file-input-label">
                            <i class="fas fa-image"></i> Choose Image
                        </label>
                        <span id="post-file-name" class="file-name">No file chosen</span>
                    </div>
                    <div id="post-image-preview" class="image-preview"></div>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Post
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block head %}
<style>
    .forum-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .forum-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .forum-header p {
        margin: 0;
        max-width: 70%;
    }
    
    /* Search and filter styles */
    .forum-search-filter {
        background-color: var(--bg-tertiary);
        border-radius: var(--border-radius);
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .search-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .search-container {
        display: flex;
        position: relative;
    }
    
    .search-container input[type="text"] {
        flex: 1;
        padding: 12px 48px 12px 12px;
        border-radius: var(--border-radius);
        border: 1px solid rgba(255, 255, 255, 0.1);
        background-color: var(--bg-secondary);
        color: var(--text-primary);
    }
    
    .search-btn {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        background: transparent;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 8px;
    }
    
    .filters-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
    }
    
    .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .filter-select {
        padding: 8px 12px;
        border-radius: var(--border-radius);
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 14px;
    }
    
    .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .filters-label {
        color: var(--text-secondary);
        font-size: 14px;
    }
    
    .filter-badge {
        display: inline-flex;
        align-items: center;
        background-color: var(--accent-primary-transparent);
        color: var(--accent-primary);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 13px;
    }
    
    .remove-filter {
        margin-left: 6px;
        font-size: 18px;
        text-decoration: none;
        color: var(--text-primary);
        opacity: 0.6;
    }
    
    .remove-filter:hover {
        opacity: 1;
    }
    
    .posts-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .forum-post {
        background-color: var(--bg-tertiary);
        border-radius: var(--border-radius);
        padding: 20px;
        backdrop-filter: blur(var(--blur));
    }
    
    .post-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .post-author {
        display: flex;
        align-items: center;
    }
    
    .post-topic {
        margin-left: auto;
        margin-right: 10px;
    }
    
    .topic-badge {
        display: inline-block;
        padding: 4px 10px;
        background-color: var(--accent-secondary-transparent);
        color: var(--accent-secondary);
        border-radius: 20px;
        font-size: 12px;
        text-decoration: none;
        transition: var(--transition);
    }
    
    .topic-badge:hover {
        background-color: var(--accent-secondary);
        color: var(--bg-primary);
    }
    
    .author-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--accent-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
    }
    
    .author-name {
        font-weight: 600;
        font-size: 14px;
    }
    
    .post-time {
        color: var(--text-secondary);
        font-size: 12px;
    }
    
    .post-title {
        font-size: 18px;
        margin-bottom: 12px;
    }
    
    .post-content {
        margin-bottom: 20px;
        color: var(--text-secondary);
        font-size: 15px;
        line-height: 1.6;
    }
    
    .post-actions {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
    }
    
    .reaction-buttons {
        display: flex;
        gap: 10px;
    }
    
    .btn-action {
        background-color: transparent;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        border-radius: var(--border-radius);
        transition: var(--transition);
    }
    
    .btn-action:hover {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
    }
    
    .btn-like.active {
        color: var(--success);
    }
    
    .btn-dislike.active {
        color: var(--danger);
    }
    
    .like-count, .dislike-count, .comment-count {
        font-weight: 600;
    }
    
    .comments-container {
        padding-top: 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .comment {
        padding: 15px;
        background-color: var(--bg-secondary);
        border-radius: var(--border-radius);
        margin-bottom: 10px;
    }
    
    .comment-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 14px;
    }
    
    .comment-author {
        font-weight: 600;
    }
    
    .comment-time {
        color: var(--text-secondary);
        font-size: 12px;
    }
    
    .comment-content {
        color: var(--text-secondary);
        font-size: 14px;
    }
    
    .comment-form {
        margin-top: 15px;
    }
    
    .comment-input-container {
        display: flex;
        gap: 10px;
    }
    
    .comment-input {
        flex: 1;
        padding: 12px;
        border-radius: 30px;
    }
    
    .btn-sm {
        padding: 8px 16px;
        font-size: 14px;
    }
    
    .empty-state {
        text-align: center;
        padding: 50px 0;
        color: var(--text-secondary);
    }
    
    .empty-icon {
        font-size: 48px;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
    }
    
    .modal-content {
        background-color: var(--bg-secondary);
        margin: 10% auto;
        padding: 20px;
        border-radius: var(--border-radius);
        max-width: 600px;
        box-shadow: var(--box-shadow);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .modal-header h2 {
        margin: 0;
    }
    
    .modal-close {
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    .post-image, .comment-image {
        margin-bottom: 15px;
        border-radius: var(--border-radius);
        overflow: hidden;
    }
    
    .post-image img, .comment-image img {
        max-width: 100%;
        display: block;
    }
    
    .file-input-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    .file-input {
        width: 0.1px;
        height: 0.1px;
        opacity: 0;
        overflow: hidden;
        position: absolute;
        z-index: -1;
    }
    
    .file-input-label {
        display: inline-block;
        padding: 8px 16px;
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: var(--transition);
    }
    
    .file-input-label:hover {
        background-color: var(--accent-primary);
    }
    
    .file-name {
        font-size: 14px;
        color: var(--text-secondary);
    }
    
    .image-preview {
        margin-top: 10px;
        max-width: 100%;
    }
    
    .image-preview img {
        max-width: 100%;
        max-height: 200px;
        border-radius: var(--border-radius);
    }
    
    .comment-image-upload {
        position: relative;
    }
    
    .file-input-icon {
        padding: 8px;
        background-color: var(--bg-tertiary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .file-input-icon:hover {
        background-color: var(--accent-primary);
    }
    
    /* Responsive styles */
    @media (max-width: 768px) {
        .forum-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        
        .forum-header p {
            max-width: 100%;
        }
        
        .search-form {
            flex-direction: column;
        }
        
        .filters-container {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .filter-group {
            width: 100%;
        }
        
        .filter-select {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const newPostBtn = document.getElementById('new-post-btn');
        const emptyNewPostBtn = document.getElementById('empty-new-post-btn');
        const newPostModal = document.getElementById('new-post-modal');
        const modalClose = document.querySelector('.modal-close');
        const forumPostForm = document.getElementById('forum-post-form');
        const filterTopicSelect = document.getElementById('filter-topic');
        const filterSortSelect = document.getElementById('filter-sort');
        
        // Show modal when button is clicked
        if (newPostBtn) {
            newPostBtn.addEventListener('click', function() {
                newPostModal.style.display = 'block';
            });
        }
        
        if (emptyNewPostBtn) {
            emptyNewPostBtn.addEventListener('click', function() {
                newPostModal.style.display = 'block';
            });
        }
        
        // Close modal when X is clicked
        if (modalClose) {
            modalClose.addEventListener('click', function() {
                newPostModal.style.display = 'none';
            });
        }
        
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target == newPostModal) {
                newPostModal.style.display = 'none';
            }
        });
        
        // Handle filter changes
        if (filterTopicSelect) {
            filterTopicSelect.addEventListener('change', function() {
                if (this.form) {
                    this.form.submit();
                }
            });
        }
        
        if (filterSortSelect) {
            filterSortSelect.addEventListener('change', function() {
                if (this.form) {
                    this.form.submit();
                }
            });
        }
        
        // Toggle comments visibility
        document.querySelectorAll('.btn-comments').forEach(button => {
            button.addEventListener('click', function() {
                const post = this.closest('.forum-post');
                const commentsContainer = post.querySelector('.comments-container');
                
                if (commentsContainer.style.display === 'block') {
                    commentsContainer.style.display = 'none';
                } else {
                    // Hide all other comment sections
                    document.querySelectorAll('.comments-container').forEach(container => {
                        container.style.display = 'none';
                    });
                    commentsContainer.style.display = 'block';
                }
            });
        });
        
        // Initially hide all comments
        document.querySelectorAll('.comments-container').forEach(container => {
            container.style.display = 'none';
        });
        
        // Post image preview
        const postImageInput = document.getElementById('post-image');
        const postImagePreview = document.getElementById('post-image-preview');
        const postFileName = document.getElementById('post-file-name');
        
        if (postImageInput) {
            postImageInput.addEventListener('change', function() {
                postFileName.textContent = this.files[0] ? this.files[0].name : 'No file chosen';
                
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        postImagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                    };
                    
                    reader.readAsDataURL(this.files[0]);
                } else {
                    postImagePreview.innerHTML = '';
                }
            });
        }
        
        // Comment image previews
        document.querySelectorAll('[id^="comment-image-"]').forEach(input => {
            const postId = input.id.split('-')[2];
            const previewContainer = document.getElementById(`comment-image-preview-${postId}`);
            
            input.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        previewContainer.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                    };
                    
                    reader.readAsDataURL(this.files[0]);
                } else {
                    previewContainer.innerHTML = '';
                }
            });
        });
        
        // Track form submissions to prevent duplicates
        let isSubmitting = false;
        
        // Post form submission
        if (forumPostForm) {
            forumPostForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Prevent duplicate submissions
                if (isSubmitting) return;
                isSubmitting = true;
                
                // Disable the submit button to prevent double submissions
                const submitButton = this.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
                }
                
                const formData = new FormData(this);
                
                fetch('/api/forum-post', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    isSubmitting = false;
                    if (data.success) {
                        // Close the modal
                        if (newPostModal) {
                            newPostModal.style.display = 'none';
                        }
                        
                        // Reload the page to show the new post
                        window.location.href = '/forum';
                    } else {
                        alert(data.error || 'Error creating post');
                        // Re-enable the submit button
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Post';
                        }
                    }
                })
                .catch(error => {
                    isSubmitting = false;
                    console.error('Error:', error);
                    // Re-enable the submit button
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> Post';
                    }
                });
            });
        }
        
        // Comment submission - use a map to track which forms are submitting
        const submittingForms = new Map();
        
        document.querySelectorAll('.comment-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const postId = this.getAttribute('data-post-id');
                
                // Prevent duplicate submissions for this form
                if (submittingForms.get(postId)) return;
                submittingForms.set(postId, true);
                
                // Disable the submit button to prevent double submissions
                const submitButton = this.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
                
                const formData = new FormData(this);
                formData.append('post_id', postId);
                
                fetch('/api/forum-comment', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    submittingForms.set(postId, false);
                    if (data.success) {
                        // Clear input and image preview
                        this.querySelector('.comment-input').value = '';
                        const previewContainer = document.getElementById(`comment-image-preview-${postId}`);
                        if (previewContainer) previewContainer.innerHTML = '';
                        
                        // Reload the page to show the new comment
                        window.location.href = '/forum';
                    } else {
                        alert(data.error || 'Error adding comment');
                        // Re-enable the submit button
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                        }
                    }
                })
                .catch(error => {
                    submittingForms.set(postId, false);
                    console.error('Error:', error);
                    // Re-enable the submit button
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    }
                });
            });
        });
        
        // Like/dislike post reactions
        document.querySelectorAll('.btn-like, .btn-dislike').forEach(button => {
            button.addEventListener('click', function() {
                const postId = this.getAttribute('data-post-id');
                const reactionType = this.classList.contains('btn-like') ? 'like' : 'dislike';
                
                fetch('/api/forum-reaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        post_id: postId,
                        reaction_type: reactionType
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const post = data.post;
                        
                        // Update UI
                        const likesCount = this.closest('.forum-post').querySelector('.btn-like .like-count');
                        const dislikesCount = this.closest('.forum-post').querySelector('.btn-dislike .dislike-count');
                        
                        if (likesCount) likesCount.textContent = post.likes;
                        if (dislikesCount) dislikesCount.textContent = post.dislikes;
                        
                        // Toggle active state
                        const likeButton = this.closest('.forum-post').querySelector('.btn-like');
                        const dislikeButton = this.closest('.forum-post').querySelector('.btn-dislike');
                        
                        if (reactionType === 'like') {
                            likeButton.classList.toggle('active');
                            dislikeButton.classList.remove('active');
                        } else {
                            dislikeButton.classList.toggle('active');
                            likeButton.classList.remove('active');
                        }
                    } else {
                        alert(data.error || 'Error processing reaction');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
        
        // Like/dislike comment reactions
        document.querySelectorAll('.btn-like-comment, .btn-dislike-comment').forEach(button => {
            button.addEventListener('click', function() {
                const commentId = this.getAttribute('data-comment-id');
                const reactionType = this.classList.contains('btn-like-comment') ? 'like' : 'dislike';
                
                fetch('/api/forum-reaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        comment_id: commentId,
                        reaction_type: reactionType
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Find the comment in the returned post data
                        let comment;
                        for (const c of data.post.comments) {
                            if (c.id == commentId) {
                                comment = c;
                                break;
                            }
                        }
                        
                        if (comment) {
                            // Update UI
                            const likesCount = this.closest('.comment').querySelector('.btn-like-comment .like-count');
                            const dislikesCount = this.closest('.comment').querySelector('.btn-dislike-comment .dislike-count');
                            
                            if (likesCount) likesCount.textContent = comment.likes;
                            if (dislikesCount) dislikesCount.textContent = comment.dislikes;
                            
                            // Toggle active state
                            const likeButton = this.closest('.comment').querySelector('.btn-like-comment');
                            const dislikeButton = this.closest('.comment').querySelector('.btn-dislike-comment');
                            
                            if (reactionType === 'like') {
                                likeButton.classList.toggle('active');
                                dislikeButton.classList.remove('active');
                            } else {
                                dislikeButton.classList.toggle('active');
                                likeButton.classList.remove('active');
                            }
                        }
                    } else {
                        alert(data.error || 'Error processing reaction');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
        
        // Delete post buttons
        document.querySelectorAll('.btn-delete-post').forEach(button => {
            button.addEventListener('click', function() {
                const postId = this.getAttribute('data-post-id');
                
                // Show confirmation dialog
                if (confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                    fetch('/api/delete-forum-post', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            post_id: postId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Remove the post from the DOM
                            const post = this.closest('.forum-post');
                            if (post) {
                                post.remove();
                            }
                            
                            // If no posts left, reload the page to show empty state
                            if (document.querySelectorAll('.forum-post').length === 0) {
                                window.location.href = '/forum';
                            }
                        } else {
                            alert(data.error || 'Error deleting post');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the post');
                    });
                }
            });
        });
        
        // Delete comment buttons
        document.querySelectorAll('.btn-delete-comment').forEach(button => {
            button.addEventListener('click', function() {
                const commentId = this.getAttribute('data-comment-id');
                
                // Show confirmation dialog
                if (confirm('Are you sure you want to delete this comment? This action cannot be undone.')) {
                    fetch('/api/delete-forum-comment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            comment_id: commentId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Remove the comment from the DOM
                            const comment = this.closest('.comment');
                            if (comment) {
                                comment.remove();
                            }
                        } else {
                            alert(data.error || 'Error deleting comment');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the comment');
                    });
                }
            });
        });
    });
</script>
{% endblock %} 